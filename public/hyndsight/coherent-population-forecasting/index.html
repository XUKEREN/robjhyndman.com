<!doctype html>
<html class="no-js" lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Coherent population forecasting using R | Rob J Hyndman</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Merriweather" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
    <link rel="stylesheet" href="/css/foundation.min.css">
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/academicons.min.css">
    <link rel="stylesheet" href="/css/finite.css">
    <link rel="stylesheet" href="/css/kube.css">
    <link rel="stylesheet" href="/css/robjhyndman.css">
</head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="/"  style="color: #b3cde0">Rob J Hyndman</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      


	    </div>
	  </div>

	  
	    <div class="top-bar" id="site-menu" >
	      <div class="top-bar-title show-for-medium site-title">
		<a href="/"  style="color: #b3cde0;">Rob J Hyndman</a>
	      </div>
	      <div class="top-bar-left">
		<ul class="menu vertical medium-horizontal">
		  
		  
		  <li><a href="/hyndsight/">Hyndsight blog</a></li>
		  
		  <li><a href="/publications/">Publications</a></li>
		  
		  <li><a href="/software/">Software</a></li>
		  
		  <li><a href="/seminars/">Seminars</a></li>
		  
		  <li><a href="/teaching/">Teaching</a></li>
		  
		  <li><a href="/research-team/">Research team</a></li>
		  
		  <li><a href="/about/">About</a></li>
		  
		</ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
		


	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      

<div class="wrapper">
<div class="units-row" style='margin-bottom: 0px;'>
<div class="unit-20">&nbsp;</div>
<div class="unit-60"><h1>Coherent population forecasting using R</h1></div>
</div>
<div class="units-row">
  <div class="unit-20 dateblock" style='text-align: right;'><h4 style='padding: .8ex 0px .8ex 0px;'><a href="/hyndsight">Hyndsight</a></h4>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2014-07-24 02:03:01 &#43;0000 &#43;0000" itemprop="datePublished">24 July 2014</time>
  </span>
  
  
  
  <span class="post-tags">
    <p><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="/categories/demography">demography</a>,
     
    
    
    <a class="post-tag" href="/categories/forecasting">forecasting</a>, 
    
    
    <a class="post-tag" href="/categories/r">R</a>, 
    
    
    <a class="post-tag" href="/categories/statistics">statistics</a>
    
  </span>
  
  
</div>

    </div>
<div class="unit-60">

  

<p>This is an example of how to use the demography package in R for stochastic population forecasting with coherent components. It is based on the papers by <a href="/publications/stochastic-population-forecasts/">Hyndman and Booth (IJF 2008)</a> and <a href="/publications/coherentfdm/">Hyndman, Booth and Yasmeen (Demography 2013)</a>. I will use Australian data from 1950 to 2009 and forecast the next 50 years.</p>

<p>In demography, &ldquo;coherent&rdquo; forecasts are where male and females (or other sub-groups) do not diverge over time. (Essentially, we require the difference between the groups to be stationary.) When we wrote the 2008 paper, we did not know how to constrain the forecasts to be coherent in a functional data context and so this was not discussed. My later 2013 paper provided a way of imposing coherence. This blog post shows how to implement both ideas using R.<!-- more --></p>

<h3 id="download-data">Download data</h3>

<p>First we need to get the historical mortality rates and the fertility rates, and the population data for 1 January in the year after the final mortality and fertility rates. As there are mortality data up to 2009 easily available for Australia, I will use population data for 1 January 2010 for this example.</p>

<p>The population and mortality data can be obtained from the <a href="http://www.mortality.org">Human Mortality Database</a>. You need a username and password, but registration is free.</p>

<pre><code>library(demography)

# Get population data for 1 Jan 2010
pop2010 &lt;- hmd.pop(&quot;AUS&quot;,username,password,&quot;Australia&quot;)
pop2010 &lt;- extract.ages(pop2010, age=0:100)

# Get mortality data
aus.mort &lt;- hmd.mx(&quot;AUS&quot;,username,password,&quot;Australia&quot;)
aus.mort &lt;- extract.years(extract.ages(aus.mort, 0:100, 
              combine.upper=FALSE), year=1950:max(aus.mort$year))
</code></pre>

<p>The fertility data for some countries is available on the <a href="http://www.humanfertility.org">Human Fertility Database</a>, but not for Australia. Instead, I have obtained the data from the Australian Bureau of Statistics and made them available in an R workspace (along with <code>pop2010</code> and <code>aus.mort</code>). <a href="https://robjhyndman.com/Rfiles/ausdata.RData">Download it here</a>.</p>

<p>Now we can construct the net migration data as the differences between the populations in consecutive years, taking account of any deaths or births.</p>

<pre><code>##### Compute net migration
aus.mig &lt;- netmigration(aus.mort, aus.fert, mfratio = 1.05)
</code></pre>

<p>Before continuing, it is important to plot the data to make sure everything looks in order.</p>

<pre><code>## Population
plot(pop2010,series=&quot;male&quot;)
plot(pop2010,series=&quot;female&quot;)
# Mortality
plot(aus.mort,'male',ylim=c(-10.4,-0.5))
plot(aus.mort,'female',ylim=c(-10.4,-0.5))
# Fertility
plot(aus.fert)
# Net migration
plot(aus.mig,'male',ylim=c(-4100,7800))
plot(aus.mig,'female',ylim=c(-4100,7800))
</code></pre>

<h3 id="smoothing-step">Smoothing step</h3>

<p>Next we smooth all data using penalized regression splines.</p>

<pre><code>ausmort.sm &lt;- smooth.demogdata(aus.mort, obs.var=&quot;theoretical&quot;)
ausfert.sm &lt;- smooth.demogdata(aus.fert, obs.var=&quot;theoretical&quot;)
ausmig.sm &lt;- smooth.demogdata(aus.mig)
</code></pre>

<h3 id="modelling-step">Modelling step</h3>

<p>Now we are ready to fit some functional data models. This part is different from the approach in Hyndman and Booth (2008) as we can now fit coherent models to prevent forecasts of the two sexes from diverging.</p>

<pre><code># MORTALITY
mort.fit &lt;- coherentfdm(ausmort.sm)

plot(residuals(mort.fit$product))
plot(residuals(mort.fit$ratio$male))

# FERTILITY
fert.fit &lt;- fdm(ausfert.sm)
plot(residuals(fert.fit))

# MIGRATION
mig.fit &lt;- coherentfdm(ausmig.sm)
plot(residuals(mig.fit$product))
plot(residuals(mig.fit$ratio$male))
</code></pre>

<p>The residuals for each model are plotted to ensure things look ok. In fact, the fertility residuals show up some weird problems with the data, but I&rsquo;ll ignore that for now and proceed.</p>

<p>Although the components of migration are called &ldquo;product&rdquo; and &ldquo;ratio&rdquo;, they are actually sums and differences as we do not use a log transformation for migration.</p>

<h3 id="forecasting-step">Forecasting step</h3>

<p>Next we fit forecasting models to the coefficients of each functional data model. Some plots are produced in each case to check that the results look reasonable.</p>

<pre><code># Mortality
mortf &lt;- forecast(mort.fit, h=50, max.d=1)

plot(mortf$product, 'c', comp=2)
plot(mort.fit$product$y, col='gray', ylim=c(-11,-0.5),
  main=&quot;Mortality forecasts product: 2010-2059&quot;)
lines(mortf$product)

plot(mortf$ratio$male, 'c', comp=2)
plot(mort.fit$ratio$male$y,col='gray',
  main=&quot;Mortality forecasts ratio (M/F): 2010-2059&quot;)
lines(mortf$ratio$male)

# Fertility
fertf &lt;- forecast(fert.fit, h=50,max.d=1)

plot(fertf, 'c', comp=2)
plot(ausfert.sm,col='gray', main=&quot;Fertility forecasts: 2010-2059&quot;)
lines(fertf)

# Migration
migf &lt;- forecast(mig.fit, h=50, stationary=TRUE)

plot(migf$product, 'c', comp=2)
plot(mig.fit$product$y, col='gray',
  main=&quot;Migration forecasts product: 2010-2059&quot;)
lines(migf$product)

plot(migf$ratio$male, 'c', comp=2)
plot(mig.fit$ratio$male$y, col='gray',
  main=&quot;Migration forecasts ratio (M/F): 2010-2059&quot;)
lines(migf$ratio$male)
</code></pre>

<h3 id="simulation-step">Simulation step</h3>

<p>Finally we can simulate future populations</p>

<pre><code>aus.sim &lt;- pop.sim(mortf, fertf, migf, firstyearpop=pop2010, N=1000)
</code></pre>

<p>The value of <code>N</code> determines the number of sample paths to simulate. I normally set to a very low number (e.g., 5) at first initially to ensure there are no bugs in the code and that the results look reasonable. Then I set it to at least 1000 and leave it to run while I make myself a coffee.</p>

<p>The object <code>aus.sim</code> is a list of two arrays of dimension 101 x 50 x <code>N</code>, one for males and one for females. The first dimension is age groups (0:100), the second dimension is the forecast horizon (2010:2059), while the third dimension gives simulated replicates.</p>

<h3 id="using-the-results">Using the results</h3>

<p>The simulations can be used to compute any quantities that can be derived from populations numbers by sex and age. For example, the mean male population for each age for the next 50 years:</p>

<pre><code>popm.mean &lt;- apply(aus.sim$male,c(1,2),mean)
</code></pre>

<p>We can also plot population pyramids with prediction intervals.</p>

<pre><code>## Means and intervals
popm.mean &lt;- apply(aus.sim$male,c(1,2),mean)
popm.lo &lt;- apply(aus.sim$male,c(1,2),quantile,p=.1)
popm.hi &lt;- apply(aus.sim$male,c(1,2),quantile,p=.9)
popf.mean &lt;- apply(aus.sim$female,c(1,2),mean)
popf.lo &lt;- apply(aus.sim$female,c(1,2),quantile,p=.1)
popf.hi &lt;- apply(aus.sim$female,c(1,2),quantile,p=.9)

##plot of total population age structure in 2030
par(mar=c(4.3,3.9,3.0,3.6))
plot(c(0,100),c(0,100),type=&quot;n&quot;, main=&quot;Forecast population: 2030&quot;,
  yaxt=&quot;n&quot;, xlab=&quot;Population ('000)&quot;,ylab=&quot;Age&quot;,xaxt=&quot;n&quot;,
  xlim=c(-1,1)*max(abs(popm.hi[,20]),abs(popf.hi[,20]))/1e3)
mtext(&quot;Male                       Female&quot;)
abline(v=0)
axis(1,at=seq(-300,0,by=50),labels=rev(seq(0,300,by=50)))
axis(1,at=seq(50,300,by=50))
axis(2,at=seq(0,100,by=10),labels=seq(0,100,by=10))
axis(4,at=seq(0,100,by=10),labels=seq(0,100,by=10))
axis(2,at=seq(0,100,by=20),labels=seq(0,100,by=20))
axis(4,at=seq(0,100,by=20),labels=seq(0,100,by=20))
axis(4,at=50,line=1.5,labels=&quot;Age&quot;,col=2,tick=FALSE)
polygon(c(-popm.lo[,20],rev(-popm.hi[,20]))/1000,c(0:100,100:0),
        col=rgb(0,0,1,alpha=.4),border=FALSE)
polygon(c(popf.lo[,20],rev(popf.hi[,20]))/1000,c(0:100,100:0),
        col=rgb(0,0,1,alpha=.4),border=FALSE)
lines(-popm.mean[,20]/1000,0:100,col=&quot;blue&quot;,lwd=2)
lines(popf.mean[,20]/1000,0:100,col=&quot;blue&quot;,lwd=2)
</code></pre>

<p><a href="/files/2030pyramid.png"><img src="/files/2030pyramid.png" alt="2030pyramid" /></a>
The shaded blue regions denote 80% prediction intervals for each age. Notice how certain we can be of the elderly population even twenty years ahead (due to the predictability of mortality rates) but how uncertain we are of the future young population (due to the lack of predictability in fertility rates).</p>


      <meta itemprop="wordCount" content="865">
      <meta itemprop="datePublished" content="2014-07-24">
      <meta itemprop="url" content="/hyndsight/coherent-population-forecasting/">

<div class='sans' style="background: #dddddd; padding: 2em;">
<div style="padding-bottom: 1em" >
<div class="share-box">
  <ul class="share">
    <li>
      <a class="facebook" href="http://www.facebook.com/sharer.php?u=%2fhyndsight%2fcoherent-population-forecasting%2f" target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter" href="https://twitter.com/intent/tweet?text=Coherent%20population%20forecasting%20using%20R. %2fhyndsight%2fcoherent-population-forecasting%2f from @robjhyndman" target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fhyndsight%2fcoherent-population-forecasting%2f&amp;title=Coherent%20population%20forecasting%20using%20R" target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo" href="http://service.weibo.com/share/share.php?url=%2fhyndsight%2fcoherent-population-forecasting%2f&amp;title=Coherent%20population%20forecasting%20using%20R" target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email" href="mailto:?subject=Coherent%20population%20forecasting%20using%20R&amp;body=%2fhyndsight%2fcoherent-population-forecasting%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


</div>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/arma-roots/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: Plotting the characteristic roots for ARIMA models</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/iif-awards/"><em>Next<span class="show-for-sr"> page</span></em>: Student forecasting awards from the IIF&nbsp;&raquo;</a></li>
      
    </ul>
    <a href="/hyndsight/">All Hyndsight posts by date</a>
</div>

<span style='font-family: Carlito'>
 <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
              return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'researchtips';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</span>

  </div>
  </div></div>

    </main>
    <footer class="whatisthis">
  <hr class='separator'/>
  <span style="font-family: Carlito, sans; font-size: 0.9em; line-height: 1.05em;">
  <div class="row">
    <div class="column small-12 medium-4">
      <figure class='image-left'>
      <a href="/" style="border-bottom: none;">
      	<img src="/img/rjh.png" alt="Portrait of the author" class='avatar' style="max-width: 50%;">
      </a>
  </figure>
  <p>
Rob&nbsp;J&nbsp;Hyndman is Professor of Statistics at <a href=https://www.monash.edu>Monash University</a>, Australia, and Editor-​​in-​​Chief of the <a href=https://ijf.forecasters.org>Inter­na­tional Jour­nal of Fore­cast­ing</a>.  </p>
    </div>
    <div class="column small-12 medium-4">
      
      <h4 id="contact">Contact</h4>
      <ul class="fa-ul">
	
	<li><i class="fa-li fa fa-university" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://www.monash.edu/business/econometrics-and-business-statistics">Department of Econometrics &amp; Business Statistics, Monash University, Clayton VIC 3800, Australia.</a></li>
	
	<li><i class="fa-li fa fa-envelope" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="mailto:Rob.Hyndman@monash.edu">Rob.Hyndman@monash.edu</a></li>
	
	<li><i class="fa-li fa fa-twitter" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://twitter.com/robjhyndman">@robjhyndman</a> on Twitter</li>
	
	<li><i class="fa-li fa fa-github-alt" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://github.com/robjhyndman/">robjhyndman</a> on GitHub</li>
	
	<li><i class="fa-li ai ai-google-scholar" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://scholar.google.com/citations?user=vamErfkAAAAJ">Google Scholar</a></li>
	
      </ul>
    </div>
    <div class="column small-12 medium-4">
      <h4>Subscribe</h4>
      <p><i><i class="fa fa-rss-square" style="color:#03396c;"></i> To receive updates from this site, you can subscribe to using an <a href="http://feeds.feedburner.com/ProfessorRobJHyndman">RSS feed reader</a> or <a href="https://feedburner.google.com/fb/a/mailverify?uri=ProfessorRobJHyndman">by email</a>.</i></p>
      <h4>Search</h4>
      <a id="searchsite">
	<form method="get" action="https://duckduckgo.com/">
	  <label for="search-field" class="show-for-sr">Search the site</label>
	  <input type="search" name="q" maxlength="255" placeholder="Search the site" id="search-field">
	  <input type="hidden" name="sites" value="https://robjhyndman.com"/>
	  <input type="hidden" name="k7" value="#faf8f8"/>
	  <input type="hidden" name="kj" value="#b33"/>
	  <input type="hidden" name="ky" value="#fafafa"/>
	  <input type="hidden" name="kx" value="b"/>
	  <input type="hidden" name="ko" value="-1"/>
	  <input type="hidden" name="k1" value="-1"/>
	  <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
	</form>
      </a>
    </div>
  </div>
  </span>
</footer>

    <div class="endofpage">
    <footer id="footer">
    <section class="wrapper small">Powered by <a href="http://gohugo.io">Hugo</a>
    and <a href="https://github.com/rstudio/blogdown">Blogdown</a>.
     &copy; <a href="https://robjhyndman.com">Rob&nbsp;J&nbsp;Hyndman</a> 1993&ndash;2018.
    </section>
    </footer>
    </div>

    <script src="/js/jquery.js"></script>
    <script src="/js/what-input.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script src="/js/finite.js"></script>

    
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script>
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>

    
    


<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5004894-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

 </body>
</html>
