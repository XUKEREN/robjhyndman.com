<!doctype html>
<html class="no-js" lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Specifying complicated groups of time series in hts | Rob J Hyndman</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Merriweather" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
    <link rel="stylesheet" href="/css/foundation.min.css">
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/academicons.min.css">
    <link rel="stylesheet" href="/css/finite.css">
    <link rel="stylesheet" href="/css/kube.css">
    <link rel="stylesheet" href="/css/robjhyndman.css">
</head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="/"  style="color: #b3cde0">Rob J Hyndman</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      


	    </div>
	  </div>

	  
	    <div class="top-bar" id="site-menu" >
	      <div class="top-bar-title show-for-medium site-title">
		<a href="/"  style="color: #b3cde0;">Rob J Hyndman</a>
	      </div>
	      <div class="top-bar-left">
		<ul class="menu vertical medium-horizontal">
		  
		  
		  <li><a href="/hyndsight/">Hyndsight blog</a></li>
		  
		  <li><a href="/publications/">Publications</a></li>
		  
		  <li><a href="/software/">Software</a></li>
		  
		  <li><a href="/seminars/">Seminars</a></li>
		  
		  <li><a href="/teaching/">Teaching</a></li>
		  
		  <li><a href="/research-team/">Research team</a></li>
		  
		  <li><a href="/about/">About</a></li>
		  
		</ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
		


	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      

<div class="wrapper">
<div class="units-row" style='margin-bottom: 0px;'>
<div class="unit-20">&nbsp;</div>
<div class="unit-60"><h1>Specifying complicated groups of time series in hts</h1></div>
</div>
<div class="units-row">
  <div class="unit-20 dateblock" style='text-align: right;'><h4 style='padding: .8ex 0px .8ex 0px;'><a href="/hyndsight">Hyndsight</a></h4>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2014-06-15 03:26:38 &#43;0000 &#43;0000" itemprop="datePublished">15 June 2014</time>
  </span>
  
  
  
  <span class="post-tags">
    <p><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="/categories/computing">computing</a>,
     
    
    
    <a class="post-tag" href="/categories/forecasting">forecasting</a>, 
    
    
    <a class="post-tag" href="/categories/hts">hts</a>, 
    
    
    <a class="post-tag" href="/categories/r">R</a>, 
    
    
    <a class="post-tag" href="/categories/stackexchange">StackExchange</a>, 
    
    
    <a class="post-tag" href="/categories/statistics">statistics</a>, 
    
    
    <a class="post-tag" href="/categories/time-series">time series</a>
    
  </span>
  
  
</div>

    </div>
<div class="unit-60">

  <p>With the latest version of the <a href="http://github.com/robjhyndman/hts">hts package for R</a>, it is now possible to specify rather complicated grouping structures relatively easily.</p>

<p>All aggregation structures can be represented as hierarchies or as cross-products of hierarchies. For example, a hierarchical time series may be based on geography: country, state, region, store. Often there is also a separate product hierarchy: product groups, product types, packet size. Forecasts of all the different types of aggregation are required; e.g., product type A within region X. The aggregation structure is a cross-product of the two hierarchies.</p>

<p>This framework includes even apparently non-hierarchical data: consider the simple case of a time series of deaths split by sex and state. We can consider sex and state as two very simple hierarchies with only one level each. Then we wish to forecast the aggregates of all combinations of the two hierarchies.</p>

<p>Any number of separate hierarchies can be combined in this way. Non-hierarchical factors such as sex can be treated as single-level hierarchies.<!-- more --></p>

<p>The hts package stores the data only at the bottom (most disaggregated) level, and records information about the various types of aggregates that are of interest. The hts() function is appropriate for a single hierarchy (i.e., strictly hierarchical data). More complicated aggregation structures can be specified using the more general gts() function.</p>

<p>Here is an example, based on <a href="http://stackoverflow.com/q/24191537">a question asked on stackoverflow</a>. The problem involves a geographical hierarchy and an industrial classification hierarchy.</p>

<p>Suppose there are two states with four and five counties respectively, and two industries with three and two sub-industries respectively. So there are 9x5 series at the most disaggregated level (sub-industry x county combinations). I will call the states A and B, and the counties A1,A2,A3,A4 and B1,B2,B3,B4,B5. I will call the industries X and Y with sub-industries Xa,Xb,Xc and Ya,Yb respectively. Suppose you have the bottom level series (the most disaggregated level) in a matrix <code>y</code>, with one column per series, and columns in the following order:</p>

<pre><code>     County A1, industry Xa
     County A1, industry Xb
     County A1, industry Xc
     County A1, industry Ya
     County A1, industry Yb
     County A2, industry Xa
     County A2, industry Xb
     County A2, industry Xc
     County A2, industry Ya
     County A2, industry Yb
    ...
     County B5, industry Xa
     County B5, industry Xb
     County B5, industry Xc
     County B5, industry Ya
     County B5, industry Yb
</code></pre>

<p>So that we have a reproducible example, I will create <code>y</code> randomly:</p>

<pre><code class="language-r">y &lt;- ts(matrix(rnorm(900),ncol=45,nrow=20))
</code></pre>

<p>Then we can construct labels for the columns of this matrix as follows:</p>

<pre><code class="language-r">blnames &lt;- paste(c(rep(&quot;A&quot;,20),rep(&quot;B&quot;,25)), # State
                 rep(1:9,each=5),                # County
                 rep(c(&quot;X&quot;,&quot;X&quot;,&quot;X&quot;,&quot;Y&quot;,&quot;Y&quot;),9),  # Industry
                 rep(c(&quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;a&quot;,&quot;b&quot;),9),  # Sub-industry
                 sep=&quot;&quot;)
    colnames(y) &lt;- blnames
</code></pre>

<p>For example, the first series in the matrix has name <code>&quot;A1Xa&quot;</code> meaning state A, county 1, industry X, sub-industry a.</p>

<p>We can then easily create the grouped time series object using</p>

<pre><code class="language-r">gy &lt;- gts(y, characters=list(c(1,1),c(1,1)))
</code></pre>

<p>Only the bottom level series are contained in <code>y</code>. The <code>characters</code> argument species what aggregations are of interest. In this case, the <code>characters</code> argument indicates there are two hierarchies (two elements in the list), and the first hierarchy is specified by the first two characters, with the second hierarchy specified by the next two characters. Each level of each hierarchy is specified using a single character (hence the 1s).</p>

<p>A slightly more complicated but analogous example (with labels taking more than one character each) is given in the help file for <code>gts</code> in v4.3 of the <code>hts</code> package.</p>

<p>It is possible to specify the grouping structure without using column labels. Then you have to specify the groups matrix which defines what aggregations are of interest. In the example above, the groups matrix is given by</p>

<pre><code class="language-r">gps &lt;- rbind(
      c(rep(1,20),rep(2,25)), # State
      rep(1:9,each=5),        # County
      rep(c(1,1,1,2,2),9),    # Industry
      rep(1:5, 9),            # Sub-industry
      c(rep(c(1,1,1,2,2),4),rep(c(3,3,3,4,4),5)), # State x industry
      c(rep(1:5, 4),rep(6:10, 5)),                # State x Sub-industry
      rep(1:18, rep(c(3,2),9))                    # County x industry
    )
</code></pre>

<p>The order of the rows does not matter. Each row is specifying an aggregation of the bottom level series which is of interest.</p>

<p>Then</p>

<pre><code class="language-r">gy &lt;- gts(y, groups=gps)
</code></pre>

<p>The advantage of using the <code>characters</code> argument is that the cross-products are handled for you. Also, if your data already comes with helpful column names that can be interpreted as specifying levels of one or more hierarchies, then there is really nothing to do but figure out what the <code>characters</code> argument should be.</p>

<p>Once the <code>gts</code> object has been created using the <code>gts()</code> function, you can proceed to forecast. For exmaple</p>

<pre><code class="language-r">fc &lt;- forecast(gy)
</code></pre>

<p>will generate forecasts for all the bottom level series, and all the aggregate series specified in the call to <code>gts()</code>. Then it will reconcile the forecasts until they add up for all the specified aggregations, and finally it returns only the reconciled bottom level series. The reconciled aggregated series can easily be constructed from these when they are required.</p>


      <meta itemprop="wordCount" content="799">
      <meta itemprop="datePublished" content="2014-06-15">
      <meta itemprop="url" content="/hyndsight/gts/">

<div class='sans' style="background: #dddddd; padding: 2em;">
<div style="padding-bottom: 1em" >
<div class="share-box">
  <ul class="share">
    <li>
      <a class="facebook" href="http://www.facebook.com/sharer.php?u=%2fhyndsight%2fgts%2f" target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter" href="https://twitter.com/intent/tweet?text=Specifying%20complicated%20groups%20of%20time%20series%20in%20hts. %2fhyndsight%2fgts%2f from @robjhyndman" target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fhyndsight%2fgts%2f&amp;title=Specifying%20complicated%20groups%20of%20time%20series%20in%20hts" target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo" href="http://service.weibo.com/share/share.php?url=%2fhyndsight%2fgts%2f&amp;title=Specifying%20complicated%20groups%20of%20time%20series%20in%20hts" target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email" href="mailto:?subject=Specifying%20complicated%20groups%20of%20time%20series%20in%20hts&amp;body=%2fhyndsight%2fgts%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


</div>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/europe2014/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: European talks. June-July 2014</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/varian-2014/"><em>Next<span class="show-for-sr"> page</span></em>: Varian on big data&nbsp;&raquo;</a></li>
      
    </ul>
    <a href="/hyndsight/">All Hyndsight posts by date</a>
</div>

<span style='font-family: Carlito'>
 <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
              return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'researchtips';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</span>

  </div>
  </div></div>

    </main>
    <footer class="whatisthis">
  <hr class='separator'/>
  <span style="font-family: Carlito, sans; font-size: 0.9em; line-height: 1.05em;">
  <div class="row">
    <div class="column small-12 medium-4">
      <figure class='image-left'>
      <a href="/" style="border-bottom: none;">
      	<img src="/img/rjh.png" alt="Portrait of the author" class='avatar' style="max-width: 50%;">
      </a>
  </figure>
  <p>
Rob&nbsp;J&nbsp;Hyndman is Professor of Statistics at <a href=https://www.monash.edu>Monash University</a>, Australia, and Editor-​​in-​​Chief of the <a href=https://ijf.forecasters.org>Inter­na­tional Jour­nal of Fore­cast­ing</a>.  </p>
    </div>
    <div class="column small-12 medium-4">
      
      <h4 id="contact">Contact</h4>
      <ul class="fa-ul">
	
	<li><i class="fa-li fa fa-university" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://www.monash.edu/business/econometrics-and-business-statistics">Department of Econometrics &amp; Business Statistics, Monash University, Clayton VIC 3800, Australia.</a></li>
	
	<li><i class="fa-li fa fa-envelope" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="mailto:Rob.Hyndman@monash.edu">Rob.Hyndman@monash.edu</a></li>
	
	<li><i class="fa-li fa fa-twitter" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://twitter.com/robjhyndman">@robjhyndman</a> on Twitter</li>
	
	<li><i class="fa-li fa fa-github-alt" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://github.com/robjhyndman/">robjhyndman</a> on GitHub</li>
	
	<li><i class="fa-li ai ai-google-scholar" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://scholar.google.com/citations?user=vamErfkAAAAJ">Google Scholar</a></li>
	
      </ul>
    </div>
    <div class="column small-12 medium-4">
      <h4>Subscribe</h4>
      <p><i><i class="fa fa-rss-square" style="color:#03396c;"></i> To receive updates from this site, you can subscribe to using an <a href="http://feeds.feedburner.com/ProfessorRobJHyndman">RSS feed reader</a> or <a href="https://feedburner.google.com/fb/a/mailverify?uri=ProfessorRobJHyndman">by email</a>.</i></p>
      <h4>Search</h4>
      <a id="searchsite">
	<form method="get" action="https://duckduckgo.com/">
	  <label for="search-field" class="show-for-sr">Search the site</label>
	  <input type="search" name="q" maxlength="255" placeholder="Search the site" id="search-field">
	  <input type="hidden" name="sites" value="https://robjhyndman.com"/>
	  <input type="hidden" name="k7" value="#faf8f8"/>
	  <input type="hidden" name="kj" value="#b33"/>
	  <input type="hidden" name="ky" value="#fafafa"/>
	  <input type="hidden" name="kx" value="b"/>
	  <input type="hidden" name="ko" value="-1"/>
	  <input type="hidden" name="k1" value="-1"/>
	  <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
	</form>
      </a>
    </div>
  </div>
  </span>
</footer>

    <div class="endofpage">
    <footer id="footer">
    <section class="wrapper small">Powered by <a href="http://gohugo.io">Hugo</a>
    and <a href="https://github.com/rstudio/blogdown">Blogdown</a>.
     &copy; <a href="https://robjhyndman.com">Rob&nbsp;J&nbsp;Hyndman</a> 1993&ndash;2018.
    </section>
    </footer>
    </div>

    <script src="/js/jquery.js"></script>
    <script src="/js/what-input.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script src="/js/finite.js"></script>

    
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script>
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>

    
    


<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5004894-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

 </body>
</html>
