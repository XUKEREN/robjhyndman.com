<!doctype html>
<html class="no-js" lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Time series cross-validation: an R example | Rob J Hyndman</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Merriweather" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
    <link rel="stylesheet" href="/css/foundation.min.css">
    <link rel="stylesheet" href="/css/highlight.min.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/academicons.min.css">
    <link rel="stylesheet" href="/css/finite.css">
    <link rel="stylesheet" href="/css/kube.css">
    <link rel="stylesheet" href="/css/robjhyndman.css">
</head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="/"  style="color: #b3cde0">Rob J Hyndman</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      


	    </div>
	  </div>

	  
	    <div class="top-bar" id="site-menu" >
	      <div class="top-bar-title show-for-medium site-title">
		<a href="/"  style="color: #b3cde0;">Rob J Hyndman</a>
	      </div>
	      <div class="top-bar-left">
		<ul class="menu vertical medium-horizontal">
		  
		  
		  <li><a href="/hyndsight/">Hyndsight blog</a></li>
		  
		  <li><a href="/publications/">Publications</a></li>
		  
		  <li><a href="/software/">Software</a></li>
		  
		  <li><a href="/seminars/">Seminars</a></li>
		  
		  <li><a href="/teaching/">Teaching</a></li>
		  
		  <li><a href="/research-team/">Research team</a></li>
		  
		  <li><a href="/about/">About</a></li>
		  
		</ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
		


	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      

<div class="wrapper">
<div class="units-row" style='margin-bottom: 0px;'>
<div class="unit-20">&nbsp;</div>
<div class="unit-60"><h1>Time series cross-validation: an R example</h1></div>
</div>
<div class="units-row">
  <div class="unit-20 dateblock" style='text-align: right;'><h4 style='padding: .8ex 0px .8ex 0px;'><a href="/hyndsight">Hyndsight</a></h4>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2011-08-26 05:23:19 &#43;0000 &#43;0000" itemprop="datePublished">26 August 2011</time>
  </span>
  
  
  
  <span class="post-tags">
    <p><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="/categories/forecasting">forecasting</a>,
     
    
    
    <a class="post-tag" href="/categories/r">R</a>, 
    
    
    <a class="post-tag" href="/categories/time-series">time series</a>
    
  </span>
  
  
</div>

    </div>
<div class="unit-60">

  <p>I was recently asked how to implement <a href="https://robjhyndman.com/hyndsight/crossvalidation/">time series cross-validation</a> in R. Time series people would normally call this &ldquo;forecast evaluation with a rolling origin&rdquo; or something similar, but it is the natural and obvious analogue to leave-one-out cross-validation for cross-sectional data, so I prefer to call it &ldquo;time series cross-validation&rdquo;.<!-- more --></p>

<p>Here is some example code applying time series CV and comparing 1-step, 2-step, &hellip;, 12-step forecasts using the Mean Absolute Error (MAE). Here I compare (1) a linear model containing trend and seasonal dummies applied to the log data; (2) an ARIMA model applied to the log data; and (3) an ETS model applied to the original data. The code is slow because I am estimating an ARIMA and ETS model for each iteration. (I&rsquo;m also estimating a linear model, but that doesn&rsquo;t take long.)</p>

<pre><code>library(fpp) # To load the data set a10
plot(a10, ylab=&quot;$ million&quot;, xlab=&quot;Year&quot;, main=&quot;Antidiabetic drug sales&quot;)
plot(log(a10), ylab=&quot;&quot;, xlab=&quot;Year&quot;, main=&quot;Log Antidiabetic drug sales&quot;)

k &lt;- 60 # minimum data length for fitting a model
n &lt;- length(a10)
mae1 &lt;- mae2 &lt;- mae3 &lt;- matrix(NA,n-k,12)
st &lt;- tsp(a10)[1]+(k-2)/12

for(i in 1:(n-k))
{
  xshort &lt;- window(a10, end=st + i/12)
  xnext &lt;- window(a10, start=st + (i+1)/12, end=st + (i+12)/12)
  fit1 &lt;- tslm(xshort ~ trend + season, lambda=0)
  fcast1 &lt;- forecast(fit1, h=12)
  fit2 &lt;- Arima(xshort, order=c(3,0,1), seasonal=list(order=c(0,1,1), period=12),
      include.drift=TRUE, lambda=0, method=&quot;ML&quot;)
  fcast2 &lt;- forecast(fit2, h=12)
  fit3 &lt;- ets(xshort,model=&quot;MMM&quot;,damped=TRUE)
  fcast3 &lt;- forecast(fit3, h=12)
  mae1[i,1:length(xnext)] &lt;- abs(fcast1[['mean']]-xnext)
  mae2[i,1:length(xnext)] &lt;- abs(fcast2[['mean']]-xnext)
  mae3[i,1:length(xnext)] &lt;- abs(fcast3[['mean']]-xnext)
}

plot(1:12, colMeans(mae1,na.rm=TRUE), type=&quot;l&quot;, col=2, xlab=&quot;horizon&quot;, ylab=&quot;MAE&quot;,
     ylim=c(0.65,1.05))
lines(1:12, colMeans(mae2,na.rm=TRUE), type=&quot;l&quot;,col=3)
lines(1:12, colMeans(mae3,na.rm=TRUE), type=&quot;l&quot;,col=4)
legend(&quot;topleft&quot;,legend=c(&quot;LM&quot;,&quot;ARIMA&quot;,&quot;ETS&quot;),col=2:4,lty=1)
</code></pre>

<p>This yields the following figure.
<img src="/files/mae1.png" alt="" /></p>

<p>A useful variation on this procedure is to keep the training window of fixed length. In that case, replace the first line in the for loop with</p>

<pre><code>xshort &lt;- window(a10, start=st+(i-k+1)/12, end=st+i/12)
</code></pre>

<p>Then the training set always consists of k observations.</p>

<p>Another variation is to compute one-step forecasts in the test set. Then the body of the for loop should be replaced with the following.</p>

<pre><code>  xshort &lt;- window(a10, end=st + i/12)
  xnext &lt;- window(a10, start=st + (i+1)/12, end=st + (i+12)/12)
  xlong &lt;- window(a10, end=st + (i+12)/12)
  fit1 &lt;- tslm(xshort ~ trend + season, lambda=0)
  fcast1 &lt;- forecast(fit1, h=12)$mean
  fit2 &lt;- Arima(xshort, order=c(3,0,1), seasonal=list(order=c(0,1,1), period=12),
                include.drift=TRUE, lambda=0, method=&quot;ML&quot;)
  fit2a &lt;- Arima(xlong, model=fit2, lambda=0)
  fcast2 &lt;- fitted(fit2a)[-(1:length(xshort))]
  fit3 &lt;- ets(xshort,model=&quot;MMM&quot;,damped=TRUE)
  fit3a &lt;- ets(xlong, model=fit3)
  fcast3 &lt;- fitted(fit3a)[-(1:length(xshort))]
  mae1[i,1:length(xnext)] &lt;- abs(fcast1-xnext)
  mae2[i,1:length(xnext)] &lt;- abs(fcast2-xnext)
  mae3[i,1:length(xnext)] &lt;- abs(fcast3-xnext)
</code></pre>

<p>Here the models are fitted to the training set (<code>xshort</code>), and then applied to the longer data set (<code>xlong</code>) without re-estimating the parameters. So the fitted values from the latter are one-step forecasts on the whole data set. Therefore, the last part of the fitted values vector are one-step forecasts on the test set.</p>

<p>Yet another variation which is useful for large data sets is to use a form of k-fold cross-validation where the training sets increment by several values at a time. For example, instead of incrementing by one observation in each iteration, we could shift the training set forward by 12 observations.</p>

<pre><code>k &lt;- 60 # minimum data length for fitting a model
n &lt;- length(a10)
mae1 &lt;- mae2 &lt;- mae3 &lt;- matrix(NA,12,12)
st &lt;- tsp(a10)[1]+(k-1)/12
for(i in 1:12)
{
  xshort &lt;- window(a10, end=st + (i-1))
  xnext &lt;- window(a10, start=st + (i-1) + 1/12, end=st + i)
  fit1 &lt;- tslm(xshort ~ trend + season, lambda=0)
  fcast1 &lt;- forecast(fit1, h=12)
  fit2 &lt;- Arima(xshort, order=c(3,0,1), seasonal=list(order=c(0,1,1), period=12),
      include.drift=TRUE, lambda=0, method=&quot;ML&quot;)
  fcast2 &lt;- forecast(fit2, h=12)
  fit3 &lt;- ets(xshort,model=&quot;MMM&quot;,damped=TRUE)
  fcast3 &lt;- forecast(fit3, h=12)
  mae1[i,] &lt;- abs(fcast1[['mean']]-xnext)
  mae2[i,] &lt;- abs(fcast2[['mean']]-xnext)
  mae3[i,] &lt;- abs(fcast3[['mean']]-xnext)
}
plot(1:12, colMeans(mae1), type=&quot;l&quot;, col=2, xlab=&quot;horizon&quot;, ylab=&quot;MAE&quot;,
     ylim=c(0.35,1.5))
lines(1:12, colMeans(mae2), type=&quot;l&quot;,col=3)
lines(1:12, colMeans(mae3), type=&quot;l&quot;,col=4)
legend(&quot;topleft&quot;,legend=c(&quot;LM&quot;,&quot;ARIMA&quot;,&quot;ETS&quot;),col=2:4,lty=1)
</code></pre>

<p>However, because this is based on fewer estimation steps, the results are much more volatile. It may be best to average over the forecast horizon as well:</p>

<pre><code>&gt; mean(mae1)
[1] 0.8053712
&gt; mean(mae2)
[1] 0.7118831
&gt; mean(mae3)
[1] 0.792813
</code></pre>

<p>The above code assumes you are using v3.02 or later of the <a href="http://github.com/robjhyndman/forecast/">forecast package</a>.</p>


      <meta itemprop="wordCount" content="653">
      <meta itemprop="datePublished" content="2011-08-26">
      <meta itemprop="url" content="/hyndsight/tscvexample/">

<div class='sans' style="background: #dddddd; padding: 2em;">
<div style="padding-bottom: 1em" >
<div class="share-box">
  <ul class="share">
    <li>
      <a class="facebook" href="http://www.facebook.com/sharer.php?u=%2fhyndsight%2ftscvexample%2f" target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter" href="https://twitter.com/intent/tweet?text=Time%20series%20cross-validation%3a%20an%20R%20example. %2fhyndsight%2ftscvexample%2f from @robjhyndman" target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fhyndsight%2ftscvexample%2f&amp;title=Time%20series%20cross-validation%3a%20an%20R%20example" target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo" href="http://service.weibo.com/share/share.php?url=%2fhyndsight%2ftscvexample%2f&amp;title=Time%20series%20cross-validation%3a%20an%20R%20example" target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email" href="mailto:?subject=Time%20series%20cross-validation%3a%20an%20R%20example&amp;body=%2fhyndsight%2ftscvexample%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


</div>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/forecast3/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: Major changes to the forecast package</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="/hyndsight/scourge/"><em>Next<span class="show-for-sr"> page</span></em>: The scourge of the academic publishers&nbsp;&raquo;</a></li>
      
    </ul>
    <a href="/hyndsight/">All Hyndsight posts by date</a>
</div>

<span style='font-family: Carlito'>
 <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
              return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'researchtips';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</span>

  </div>
  </div></div>

    </main>
    <footer class="whatisthis">
  <hr class='separator'/>
  <span style="font-family: Carlito, sans; font-size: 0.9em; line-height: 1.05em;">
  <div class="row">
    <div class="column small-12 medium-4">
      <figure class='image-left'>
      <a href="/" style="border-bottom: none;">
      	<img src="/img/rjh.png" alt="Portrait of the author" class='avatar' style="max-width: 50%;">
      </a>
  </figure>
  <p>
Rob&nbsp;J&nbsp;Hyndman is Professor of Statistics at <a href=https://www.monash.edu>Monash University</a>, Australia, and Editor-​​in-​​Chief of the <a href=https://ijf.forecasters.org>Inter­na­tional Jour­nal of Fore­cast­ing</a>.  </p>
    </div>
    <div class="column small-12 medium-4">
      
      <h4 id="contact">Contact</h4>
      <ul class="fa-ul">
	
	<li><i class="fa-li fa fa-university" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://www.monash.edu/business/econometrics-and-business-statistics">Department of Econometrics &amp; Business Statistics, Monash University, Clayton VIC 3800, Australia.</a></li>
	
	<li><i class="fa-li fa fa-envelope" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="mailto:Rob.Hyndman@monash.edu">Rob.Hyndman@monash.edu</a></li>
	
	<li><i class="fa-li fa fa-twitter" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://twitter.com/robjhyndman">@robjhyndman</a> on Twitter</li>
	
	<li><i class="fa-li fa fa-github-alt" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://github.com/robjhyndman/">robjhyndman</a> on GitHub</li>
	
	<li><i class="fa-li ai ai-google-scholar" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://scholar.google.com/citations?user=vamErfkAAAAJ">Google Scholar</a></li>
	
      </ul>
    </div>
    <div class="column small-12 medium-4">
      <h4>Subscribe</h4>
      <p><i><i class="fa fa-rss-square" style="color:#03396c;"></i> To receive updates from this site, you can subscribe to using an <a href="http://feeds.feedburner.com/ProfessorRobJHyndman">RSS feed reader</a> or <a href="https://feedburner.google.com/fb/a/mailverify?uri=ProfessorRobJHyndman">by email</a>.</i></p>
      <h4>Search</h4>
      <a id="searchsite">
	<form method="get" action="https://duckduckgo.com/">
	  <label for="search-field" class="show-for-sr">Search the site</label>
	  <input type="search" name="q" maxlength="255" placeholder="Search the site" id="search-field">
	  <input type="hidden" name="sites" value="https://robjhyndman.com"/>
	  <input type="hidden" name="k7" value="#faf8f8"/>
	  <input type="hidden" name="kj" value="#b33"/>
	  <input type="hidden" name="ky" value="#fafafa"/>
	  <input type="hidden" name="kx" value="b"/>
	  <input type="hidden" name="ko" value="-1"/>
	  <input type="hidden" name="k1" value="-1"/>
	  <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
	</form>
      </a>
    </div>
  </div>
  </span>
</footer>

    <div class="endofpage">
    <footer id="footer">
    <section class="wrapper small">Powered by <a href="http://gohugo.io">Hugo</a>
    and <a href="https://github.com/rstudio/blogdown">Blogdown</a>.
     &copy; <a href="https://robjhyndman.com">Rob&nbsp;J&nbsp;Hyndman</a> 1993&ndash;2018.
    </section>
    </footer>
    </div>

    <script src="/js/jquery.js"></script>
    <script src="/js/what-input.js"></script>
    <script src="/js/foundation.min.js"></script>
    <script src="/js/finite.js"></script>

    
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script>
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>

    
    


<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-5004894-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

 </body>
</html>
