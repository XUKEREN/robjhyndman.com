<!doctype html>
<html class="no-js" lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>Piecewise linear trends | Rob J Hyndman</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Merriweather" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/foundation.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/highlight.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/academicons.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/finite.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/kube.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/robjhyndman.css">
</head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="https://robjhyndman.com/"  style="color: #b3cde0">Rob J Hyndman</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      


	    </div>
	  </div>

	  
	    <div class="top-bar" id="site-menu" >
	      <div class="top-bar-title show-for-medium site-title">
		<a href="https://robjhyndman.com/"  style="color: #b3cde0;">Rob J Hyndman</a>
	      </div>
	      <div class="top-bar-left">
		<ul class="menu vertical medium-horizontal">
		  
		  
		  <li><a href="https://robjhyndman.com/hyndsight/">Hyndsight blog</a></li>
		  
		  <li><a href="https://robjhyndman.com/publications/">Publications</a></li>
		  
		  <li><a href="https://robjhyndman.com/software/">Software</a></li>
		  
		  <li><a href="https://robjhyndman.com/seminars/">Seminars</a></li>
		  
		  <li><a href="https://robjhyndman.com/teaching/">Teaching</a></li>
		  
		  <li><a href="https://robjhyndman.com/research-team/">Research team</a></li>
		  
		  <li><a href="https://robjhyndman.com/about/">About</a></li>
		  
		</ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
		


	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      

<div class="wrapper">
<div class="units-row" style='margin-bottom: 0px;'>
<div class="unit-20">&nbsp;</div>
<div class="unit-60"><h1>Piecewise linear trends</h1></div>
</div>
<div class="units-row">
  <div class="unit-20 dateblock" style='text-align: right;'><h4 style='padding: .8ex 0px .8ex 0px;'><a href="https://robjhyndman.com/hyndsight">Hyndsight</a></h4>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2015-10-28 02:43:47 &#43;0000 &#43;0000" itemprop="datePublished">28 October 2015</time>
  </span>
  
  
  
  <span class="post-tags">
    <p><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="https://robjhyndman.com/categories/forecasting">forecasting</a>,
     
    
    
    <a class="post-tag" href="https://robjhyndman.com/categories/r">R</a>, 
    
    
    <a class="post-tag" href="https://robjhyndman.com/categories/time-series">time series</a>, 
    
    
    <a class="post-tag" href="https://robjhyndman.com/categories/trend">trend</a>
    
  </span>
  
  
</div>

    </div>
<div class="unit-60">

  <p>I prepared the following notes for a consulting client, and I thought they might be of interest to some other people too.</p>
<p>Let <span class="math inline">\(y_t\)</span> denote the value of the time series at time <span class="math inline">\(t\)</span>, and suppose we wish to fit a trend with correlated errors of the form
<span class="math display">\[ y_t = f(t) + n_t, \]</span>
where <span class="math inline">\(f(t)\)</span> represents the possibly nonlinear trend and <span class="math inline">\(n_t\)</span> is an autocorrelated error process.</p>
<p>For example, if <span class="math inline">\(f(t) = \beta_0+\beta_1 t\)</span> is a linear function, then we can simply set <span class="math inline">\(x_{1,t}=t\)</span> and define
<span class="math display">\[ y_t = \beta_0 + \beta_1x_{1,t} + n_t. \]</span>
In matrix form we can write
<span class="math display">\[ \boldsymbol{y} = \beta_0 + \boldsymbol{X}\boldsymbol{\beta} + \boldsymbol{n},\]</span>
where <span class="math inline">\(\boldsymbol{y}=[y_1,\dots,y_T]&#39;\)</span>, <span class="math inline">\(\boldsymbol{n}=[n_1,\dots,n_T]&#39;\)</span>, <span class="math inline">\(\boldsymbol{\beta}=[\beta_1]\)</span> and <span class="math inline">\(\boldsymbol{X} = [x_{1,1},\dots,x_{1,T}]&#39;\)</span>. Note that I have left the intercept <span class="math inline">\(\beta\_0\)</span> out of the vector <span class="math inline">\(\boldsymbol{\beta}\)</span> so that the <span class="math inline">\(\boldsymbol{X}\)</span> matrix matches the required <code>xreg</code> argument in <code>auto.arima</code>.</p>
<p>This model can be estimated by setting the <code>xreg</code> argument to be a matrix with one column:
<span class="math display">\[
\boldsymbol{X} = \left[\begin{array}{c}
1\\
2\\
3\\
4\\
\vdots\\
T
\end{array}\right]
\]</span></p>
<pre class="r"><code>x1 &lt;- 1:length(y)
fit &lt;- auto.arima(y, xreg=x1)</code></pre>
<p>The associated coefficient is the slope of the trend line.</p>
<p>Here is a simple example of a linear trend fitted to the Asian sheep data from the <code>fpp</code> package :</p>
<pre class="r"><code>library(fpp)
T &lt;- length(livestock)
x1 &lt;- seq(T)
fit &lt;- auto.arima(livestock, xreg=x1)
fc &lt;- forecast(fit, xreg=T+seq(10))
b0 &lt;- coef(fit)[&quot;intercept&quot;]
b1 &lt;- coef(fit)[&quot;x1&quot;]
t &lt;- seq(T+10)
trend &lt;- ts(b0 + b1*t, start=start(livestock))

plot(fc, main=&quot;Linear trend with AR(1) errors&quot;)
lines(trend, col=&#39;red&#39;)</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-1"></span>
<img src="https://robjhyndman.com/hyndsight/2015-10-28-piecewise-linear-trends_files/figure-html/unnamed-chunk-1-1.png" alt="*A linear trend fitted to the Asian sheep data. The automatically selected error term is an AR(1) process.*" width="672" />
<p class="caption">
Figure 1: <em>A linear trend fitted to the Asian sheep data. The automatically selected error term is an AR(1) process.</em>
</p>
</div>
<p>A more flexible approach is to use a piecewise linear trend which bends at some time. If the trend bends at time <span class="math inline">\(\tau\)</span>, then it can be specified by including the following predictors in the model.
<span class="math display">\[\begin{align}
 x_{1,t}  &amp;=  t \\
 x_{2,t} &amp;=  \begin{cases}
0 &amp; t &lt; \tau;\\
(t-\tau) &amp;  t \ge \tau.
\end{cases}
\end{align}\]</span>
In <code>auto.arima</code>, set <code>xreg</code> to be a matrix with two columns:
<span class="math display">\[
\boldsymbol{X} = \left[\begin{array}{ll}
1 &amp; 0\\
2 &amp; 0\\
3 &amp; 0\\
4 &amp; 0\\
\vdots\\
\tau &amp; 0 \\
\tau+1 &amp; 1\\
\tau+2 &amp; 2\\
\vdots \\
T &amp; T-\tau
\end{array}\right]
\]</span></p>
<pre class="r"><code>fit &lt;- auto.arima(y, xreg=cbind(x1, pmax(0,x1-tau))</code></pre>
<p>If the associated coefficients of <span class="math inline">\(x_{1,t}\)</span> and <span class="math inline">\(x_{2,t}\)</span> are <span class="math inline">\(\beta_1\)</span> and <span class="math inline">\(\beta_2\)</span>, then <span class="math inline">\(\beta_1\)</span> gives the slope of the trend before time <span class="math inline">\(\tau\)</span>, while the slope of the line after time <span class="math inline">\(\tau\)</span> is given by <span class="math inline">\(\beta_1+\beta_2\)</span>.</p>
<p>This can be extended to allow any number of “bend points” known as knots. Just add additional columns with 0s before each knot, and values 1, 2, … after the knot.</p>
<p>Here is a piecewise linear trend fitted to the Asian sheep data with knots at years 1990 and 1992:</p>
<pre class="r"><code>x2 &lt;- pmax(0, x1-30)
x3 &lt;- pmax(0, x1-32)
fit &lt;- auto.arima(livestock, xreg=cbind(x1,x2,x3))
fc &lt;- forecast(fit,
       xreg=cbind(max(x1)+seq(10), max(x2)+seq(10), max(x3)+seq(10)))
b0 &lt;- coef(fit)[&quot;intercept&quot;]
b1 &lt;- coef(fit)[&quot;x1&quot;]
b2 &lt;- coef(fit)[&quot;x2&quot;]
b3 &lt;- coef(fit)[&quot;x3&quot;]
trend &lt;- ts(b0 + b1*t + b2*pmax(0,t-30) + b3*pmax(0,t-32),
       start=start(livestock))

plot(fc, main=&quot;Piecewise linear trend with AR(1) errors&quot;)
lines(trend, col=&#39;red&#39;)</code></pre>
<div class="figure"><span id="fig:unnamed-chunk-2"></span>
<img src="https://robjhyndman.com/hyndsight/2015-10-28-piecewise-linear-trends_files/figure-html/unnamed-chunk-2-1.png" alt="*A piecewise-linear trend fitted to the Asian sheep data.*" width="672" />
<p class="caption">
Figure 2: <em>A piecewise-linear trend fitted to the Asian sheep data.</em>
</p>
</div>
<p>If there is to be no trend before the first knot, but a piecewise linear trend thereafter, leave out the first column of the above matrix <span class="math inline">\(\boldsymbol{X}\)</span>.</p>
<p>If there is to be a piecewise linear trend up to the last knot, but no trend thereafter, a slightly modified set up can be used. For one knot at time <span class="math inline">\(\tau\)</span>, we can set
<span class="math display">\[
\boldsymbol{X} = \left[\begin{array}{r}
1-\tau \\
2-\tau \\
\vdots\\
-2\\
-1\\
0 \\
0 \\
\vdots \\
0
\end{array}\right]
\]</span></p>
<pre class="r"><code>xreg &lt;- pmin(0, x1-tau)</code></pre>
<p>where the first 0 in the column is in row <span class="math inline">\(\tau\)</span>. Additional knots can be handled in the same way. For example, if there are two knots, then <span class="math inline">\(\beta_1+\beta_2\)</span> will be the slope of the trend up to the first knot, and <span class="math inline">\(\beta_2\)</span> will be the slope between the first and second knots.</p>


      <meta itemprop="wordCount" content="659">
      <meta itemprop="datePublished" content="2015-10-28">
      <meta itemprop="url" content="https://robjhyndman.com/hyndsight/piecewise-linear-trends/">

<div class='sans' style="background: #dddddd; padding: 2em;">
<div style="padding-bottom: 1em" >
<div class="share-box">
  <ul class="share">
    <li>
      <a class="facebook" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fpiecewise-linear-trends%2f" target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter" href="https://twitter.com/intent/tweet?text=Piecewise%20linear%20trends. https%3a%2f%2frobjhyndman.com%2fhyndsight%2fpiecewise-linear-trends%2f from @robjhyndman" target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fpiecewise-linear-trends%2f&amp;title=Piecewise%20linear%20trends" target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo" href="http://service.weibo.com/share/share.php?url=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fpiecewise-linear-trends%2f&amp;title=Piecewise%20linear%20trends" target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email" href="mailto:?subject=Piecewise%20linear%20trends&amp;body=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fpiecewise-linear-trends%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


</div>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="https://robjhyndman.com/hyndsight/forecast6-2/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: forecast package v6.2</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="https://robjhyndman.com/hyndsight/jobs2016/"><em>Next<span class="show-for-sr"> page</span></em>: Jobs at Monash University&nbsp;&raquo;</a></li>
      
    </ul>
    <a href="https://robjhyndman.com/hyndsight/">All Hyndsight posts by date</a>
</div>

<span style='font-family: Carlito'>
 <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
              return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'researchtips';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</span>

  </div>
  </div></div>

    </main>
    <footer class="whatisthis">
  <hr class='separator'/>
  <span style="font-family: Carlito, sans; font-size: 0.9em; line-height: 1.05em;">
  <div class="row">
    <div class="column small-12 medium-4">
      <figure class='image-left'>
      <a href="https://robjhyndman.com/" style="border-bottom: none;">
      	<img src="https://robjhyndman.com/img/rjh.png" alt="Portrait of the author" class='avatar' style="max-width: 50%;">
      </a>
  </figure>
  <p>
Rob&nbsp;J&nbsp;Hyndman is Professor of Statistics at <a href=https://www.monash.edu>Monash University</a>, Australia, and Editor-​​in-​​Chief of the <a href=https://ijf.forecasters.org>Inter­na­tional Jour­nal of Fore­cast­ing</a>.  </p>
    </div>
    <div class="column small-12 medium-4">
      
      <h4 id="contact">Contact</h4>
      <ul class="fa-ul">
	
	<li><i class="fa-li fa fa-university" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://www.monash.edu/business/econometrics-and-business-statistics">Department of Econometrics &amp; Business Statistics, Monash University, Clayton VIC 3800, Australia.</a></li>
	
	<li><i class="fa-li fa fa-envelope" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="mailto:Rob.Hyndman@monash.edu">Rob.Hyndman@monash.edu</a></li>
	
	<li><i class="fa-li fa fa-twitter" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://twitter.com/robjhyndman">@robjhyndman</a> on Twitter</li>
	
	<li><i class="fa-li fa fa-github-alt" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://github.com/robjhyndman/">robjhyndman</a> on GitHub</li>
	
	<li><i class="fa-li ai ai-google-scholar" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://scholar.google.com/citations?user=vamErfkAAAAJ">Google Scholar</a></li>
	
      </ul>
    </div>
    <div class="column small-12 medium-4">
      <h4>Subscribe</h4>
      <p><i><i class="fa fa-rss-square" style="color:#03396c;"></i> To receive updates from this site, you can subscribe to using an <a href="http://feeds.feedburner.com/ProfessorRobJHyndman">RSS feed reader</a> or <a href="https://feedburner.google.com/fb/a/mailverify?uri=ProfessorRobJHyndman">by email</a>.</i></p>
      <h4>Search</h4>
      <a id="searchsite">
	<form method="get" action="https://duckduckgo.com/">
	  <label for="search-field" class="show-for-sr">Search the site</label>
	  <input type="search" name="q" maxlength="255" placeholder="Search the site" id="search-field">
	  <input type="hidden" name="sites" value="https://robjhyndman.com"/>
	  <input type="hidden" name="k7" value="#faf8f8"/>
	  <input type="hidden" name="kj" value="#b33"/>
	  <input type="hidden" name="ky" value="#fafafa"/>
	  <input type="hidden" name="kx" value="b"/>
	  <input type="hidden" name="ko" value="-1"/>
	  <input type="hidden" name="k1" value="-1"/>
	  <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
	</form>
      </a>
    </div>
  </div>
  </span>
</footer>

    <div class="endofpage">
    <footer id="footer">
    <section class="wrapper small">Powered by <a href="http://gohugo.io">Hugo</a>
    and <a href="https://github.com/rstudio/blogdown">Blogdown</a>.
     &copy; <a href="https://robjhyndman.com">Rob&nbsp;J&nbsp;Hyndman</a> 1993&ndash;2018.
    </section>
    </footer>
    </div>

    <script src="https://robjhyndman.com/js/jquery.js"></script>
    <script src="https://robjhyndman.com/js/what-input.js"></script>
    <script src="https://robjhyndman.com/js/foundation.min.js"></script>
    <script src="https://robjhyndman.com/js/finite.js"></script>

    
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

    <script>
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
    </script>

    
    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
      });
    </script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML">
    </script>
    


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5004894-1', 'auto');
ga('send', 'pageview');
</script>

 </body>
</html>
