<!doctype html>
<html class="no-js" lang="en-US">
  <head>
    <meta charset="utf-8">
    <title>R packages for forecast combinations | Rob J Hyndman</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Merriweather" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3/build/web/hack-subset.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/foundation.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/highlight.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/academicons.min.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/finite.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/kube.css">
    <link rel="stylesheet" href="https://robjhyndman.com/css/robjhyndman.css">
  </head>
  <body>
    <header>
      <nav class="nav-bar">
	
	  <div class="title-bar" data-responsive-toggle="site-menu" data-hide-for="medium">
	    <button class="site-hamburger" type="button" data-toggle>
	      <i class="fa fa-bars fa-lg" aria-hidden="true"></i>
	    </button>
	    <div class="title-bar-title site-title">
	      <a href="https://robjhyndman.com/"  style="color: #b3cde0">Rob J Hyndman</a>
	    </div>
	    <div class="title-bar-right pull-right">
	      


	    </div>
	  </div>

	  
	    <div class="top-bar" id="site-menu" >
	      <div class="top-bar-title show-for-medium site-title">
		<a href="https://robjhyndman.com/"  style="color: #b3cde0;">Rob J Hyndman</a>
	      </div>
	      <div class="top-bar-left">
		<ul class="menu vertical medium-horizontal">
		  
		  
		  <li><a href="https://robjhyndman.com/hyndsight/">Hyndsight blog</a></li>
		  
		  <li><a href="https://robjhyndman.com/publications/">Publications</a></li>
		  
		  <li><a href="https://robjhyndman.com/software/">Software</a></li>
		  
		  <li><a href="https://robjhyndman.com/seminars/">Seminars</a></li>
		  
		  <li><a href="https://robjhyndman.com/teaching/">Teaching</a></li>
		  
		  <li><a href="https://robjhyndman.com/research-team/">Research team</a></li>
		  
		  <li><a href="https://robjhyndman.com/about/">About</a></li>
		  
		</ul>
	      </div>
	      <div class="top-bar-right show-for-medium">
		


	      </div>
	    </div>
	  
	</nav>
    </header>
    <main>
      

<div class="wrapper">
<div class="units-row" style='margin-bottom: 0px;'>
<div class="unit-20">&nbsp;</div>
<div class="unit-60"><h1>R packages for forecast combinations</h1></div>
</div>
<div class="units-row">
  <div class="unit-20 dateblock" style='text-align: right;'><h4 style='padding: .8ex 0px .8ex 0px;'><a href="https://robjhyndman.com/hyndsight">Hyndsight</a></h4>
      <div class="post-metadata">
  <span class="post-date">
    <time datetime="2016-09-01 09:56:16 &#43;0000 &#43;0000" itemprop="datePublished">1 September 2016</time>
  </span>
  
  
  
  <span class="post-tags">
    <p><i class="fa fa-tags"></i>
    
    <a class="post-tag" href="https://robjhyndman.com/categories/forecasting">forecasting</a>,
     
    
    
    <a class="post-tag" href="https://robjhyndman.com/categories/r">R</a>
    
  </span>
  
  
</div>

    </div>
<div class="unit-60">

  <p>It has been well-known since at least 1969, when Bates and Granger wrote their famous paper on <a href="https://www.jstor.org/stable/3008764">“The Combination of Forecasts”</a>, that combining forecasts often leads to better forecast accuracy.</p>
<p>So it is helpful to have a couple of new R packages which do just that: <strong>opera</strong> and <strong>forecastHybrid</strong>.</p>
<!-- more -->
<div id="opera" class="section level2">
<h2>opera</h2>
<p>Opera stands for “Online Prediction by ExpeRt Aggregation”. It was written by Pierre Gaillard and Yannig Goude, and Pierre provides a nice introduction in <a href="https://cran.r-project.org/web/packages/opera/vignettes/opera-vignette.html">the vignette</a>. While it can be used with combining any sort of predictions, I will just consider simple univariate time series forecasts, using the monthly <code>co2</code> data.</p>
<pre class="r"><code>library(forecast)
library(ggplot2)
train &lt;- window(co2, end=c(1990,12))
test &lt;- window(co2, start=c(1991,1))
h &lt;- length(test)
ETS &lt;- forecast(ets(train), h=h)
ARIMA &lt;- forecast(auto.arima(train, lambda=0), h=h)
STL &lt;- stlf(train, lambda=0, h=h)
X &lt;- cbind(ETS=ETS$mean, ARIMA=ARIMA$mean, STL=STL$mean)
df &lt;- cbind(co2, X)
colnames(df) &lt;- c(&quot;Data&quot;,&quot;ETS&quot;,&quot;ARIMA&quot;,&quot;STL&quot;)
autoplot(df) +
  xlab(&quot;Year&quot;) + ylab(expression(&quot;Atmospheric concentration of CO&quot;[2]))</code></pre>
<p><img src="https://robjhyndman.com/hyndsight/2016-09-01-forecast-combinations_files/figure-html/opera-1.png" width="672" /></p>
<p>Here, ETS has done a particularly bad job at picking the trend, while the other two look ok.</p>
<p>The mixture function from the <code>opera</code> package computes weights when combining the forecasts based on how well it has done up to that point.</p>
<pre class="r"><code>library(opera)
MLpol0 &lt;- mixture(model = &quot;MLpol&quot;, loss.type = &quot;square&quot;)
weights &lt;- predict(MLpol0, X, test, type=&#39;weights&#39;)
head(weights)</code></pre>
<pre><code>##             X1        X2        X3
## [1,] 0.3333333 0.3333333 0.3333333
## [2,] 0.5403809 0.0000000 0.4596191
## [3,] 0.6531038 0.0000000 0.3468962
## [4,] 0.4637675 0.0000000 0.5362325
## [5,] 0.0000000 0.0000000 1.0000000
## [6,] 0.0000000 0.0000000 1.0000000</code></pre>
<pre class="r"><code>tail(weights)</code></pre>
<pre><code>##       X1 X2 X3
## [79,]  0  1  0
## [80,]  0  1  0
## [81,]  0  1  0
## [82,]  0  1  0
## [83,]  0  1  0
## [84,]  0  1  0</code></pre>
<p>It begins with weighting each forecast method equally, quickly drops the ARIMA method, and then switches to ETS alone. But by the end of the test set, it is giving weight 0.23 to ETS, 0.36 to ARIMA and 0.41 to STL. Here are the resulting forecasts:</p>
<pre class="r"><code>z &lt;- ts(predict(MLpol0, X, test, type=&#39;response&#39;), start=c(1991,1), freq=12)
df &lt;- cbind(co2, z)
colnames(df) &lt;- c(&quot;Data&quot;,&quot;Mixture&quot;)
autoplot(df) +
  xlab(&quot;Year&quot;) + ylab(expression(&quot;Atmospheric concentration of CO&quot;[2]))</code></pre>
<p><img src="https://robjhyndman.com/hyndsight/2016-09-01-forecast-combinations_files/figure-html/opera3-1.png" width="672" /></p>
</div>
<div id="forecasthybrid" class="section level2">
<h2>forecastHybrid</h2>
<p>The <code>forecastHybrid</code> package from David Shaub and Peter Ellis fits multiple models from the <code>forecast</code> package and then combines them using either equal weights, or weights based on in-sample errors. By default, the models combined are from the <code>auto.arima</code>, <code>ets</code>, <code>nnetar</code>, <code>stlm</code> and <code>tbats</code> functions. David Shaub provides a <a href="https://cran.r-project.org/web/packages/forecastHybrid/vignettes/forecastHybrid.html">helpful vignette</a> explaining how to use the package.</p>
<p>Here is an example using the same <code>co2</code> data.</p>
<pre class="r"><code>library(forecastHybrid)
fit1 &lt;- hybridModel(train, weights=&quot;equal&quot;)</code></pre>
<pre><code>## Fitting the auto.arima model
## Fitting the ets model
## Fitting the thetam model
## Fitting the nnetar model
## Fitting the stlm model
## Fitting the tbats model</code></pre>
<pre class="r"><code>fit2 &lt;- hybridModel(train, weights=&quot;insample&quot;)</code></pre>
<pre><code>## Fitting the auto.arima model
## Fitting the ets model
## Fitting the thetam model
## Fitting the nnetar model
## Fitting the stlm model
## Fitting the tbats model</code></pre>
<pre class="r"><code>fc1 &lt;- forecast(fit1, h=h)
fc2 &lt;- forecast(fit2, h=h)
autoplot(fc1) + ggtitle(&quot;Hybrid 1&quot;) + xlab(&quot;Year&quot;) +
 ylab(expression(&quot;Atmospheric concentration of CO&quot;[2]))</code></pre>
<p><img src="https://robjhyndman.com/hyndsight/2016-09-01-forecast-combinations_files/figure-html/forecastHybrid-1.png" width="672" /></p>
<p>Those prediction intervals look dodgy because they are way too conservative. The package is taking the widest possible intervals that includes all the intervals produced by the individual models. So you only need one bad model, and the prediction intervals are screwed. To compute prediction intervals with the required coverage, it would be necessary to estimate the covariances between the different forecast errors, and then find the resulting variance expression for the linear combination of methods.</p>
<p>The combination point forecasts look much better:</p>
<pre class="r"><code>df &lt;- cbind(Data=co2, Hybrid1=fc1$mean, Hybrid2=fc2$mean)
autoplot(df) +
  xlab(&quot;Year&quot;) + ylab(expression(&quot;Atmospheric concentration of CO&quot;[2]))</code></pre>
<p><img src="https://robjhyndman.com/hyndsight/2016-09-01-forecast-combinations_files/figure-html/forecastHybrid2-1.png" width="672" /></p>
<p>Note that the weights are not being updated, unlike with the <code>opera</code> package. In this particular example, the <code>opera</code> forecasts are doing substantially better:</p>
<pre class="r"><code>mse &lt;- c(Opera=mean((test-z)^2),
          Hybrid1=mean((test - fc1$mean)^2),
          Hybrid2=mean((test - fc2$mean)^2))
round(mse,2)</code></pre>
<pre><code>##   Opera Hybrid1 Hybrid2 
##    0.68    0.66    1.15</code></pre>
<p>It should be noted, however, that the opera weights are updated using the past test data, while the forecastHybrid weights are based only on the training data. So this comparison is not entirely “fair”.</p>
<p>Also, all of these results are much better than any of the individual forecasting methods:</p>
<pre class="r"><code>mse2 &lt;- c(ETS=mean((test-ETS$mean)^2),
          ARIMA=mean((test-ARIMA$mean)^2),
          STL=mean((test-STL$mean)^2))
round(mse2,2)</code></pre>
<pre><code>##   ETS ARIMA   STL 
##  1.34  0.68  2.10</code></pre>
</div>


      <meta itemprop="wordCount" content="700">
      <meta itemprop="datePublished" content="2016-09-01">
      <meta itemprop="url" content="https://robjhyndman.com/hyndsight/forecast-combinations/">

<div class='sans' style="background: #dddddd; padding: 2em;">
<div style="padding-bottom: 1em" >
<div class="share-box">
  <ul class="share">
    <li>
      <a class="facebook" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fforecast-combinations%2f" target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter" href="https://twitter.com/intent/tweet?text=R%20packages%20for%20forecast%20combinations. https%3a%2f%2frobjhyndman.com%2fhyndsight%2fforecast-combinations%2f from @robjhyndman" target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fforecast-combinations%2f&amp;title=R%20packages%20for%20forecast%20combinations" target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo" href="http://service.weibo.com/share/share.php?url=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fforecast-combinations%2f&amp;title=R%20packages%20for%20forecast%20combinations" target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email" href="mailto:?subject=R%20packages%20for%20forecast%20combinations&amp;body=https%3a%2f%2frobjhyndman.com%2fhyndsight%2fforecast-combinations%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


</div>

    <ul class="pagination" role="navigation" aria-label="Pagination">
      
      <li class="arrow" aria-disabled="true"><a href="https://robjhyndman.com/hyndsight/isf2017-sponsorship/">&laquo; <em>Previous<span class="show-for-sr"> page</span></em>: Sponsorship for the Cairns forecasting conference</a></li>
      
      
      <li class="arrow" aria-disabled="true"><a href="https://robjhyndman.com/hyndsight/forecast-v7-2/"><em>Next<span class="show-for-sr"> page</span></em>: R package forecast v7.2 now on CRAN&nbsp;&raquo;</a></li>
      
    </ul>
    <a href="https://robjhyndman.com/hyndsight/">All Hyndsight posts by date</a>
</div>

<span style='font-family: Carlito'>
 <div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
              return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'researchtips';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</span>

  </div>
  </div></div>

    </main>
    <footer class="whatisthis">
  <hr class='separator'/>
  <span style="font-family: Carlito, sans; font-size: 0.9em; line-height: 1.05em;">
  <div class="row">
    <div class="column small-12 medium-4">
      <figure class='image-left'>
      <a href="https://robjhyndman.com/" style="border-bottom: none;">
      	<img src="https://robjhyndman.com/img/rjh.png" alt="Portrait of the author" class='avatar' style="max-width: 50%;">
      </a>
  </figure>
  <p>
Rob&nbsp;J&nbsp;Hyndman is Professor of Statistics at <a href=https://www.monash.edu>Monash University</a>, Australia, and Editor-​​in-​​Chief of the <a href=https://ijf.forecasters.org>Inter­na­tional Jour­nal of Fore­cast­ing</a>.  </p>
    </div>
    <div class="column small-12 medium-4">
      
      <h4 id="contact">Contact</h4>
      <ul class="fa-ul">
	
	<li><i class="fa-li fa fa-university" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://www.monash.edu/business/econometrics-and-business-statistics">Department of Econometrics &amp; Business Statistics, Monash University, Clayton VIC 3800, Australia.</a></li>
	
	<li><i class="fa-li fa fa-envelope" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="mailto:Rob.Hyndman@monash.edu">Rob.Hyndman@monash.edu</a></li>
	
	<li><i class="fa-li fa fa-twitter" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://twitter.com/robjhyndman">@robjhyndman</a> on Twitter</li>
	
	<li><i class="fa-li fa fa-github-alt" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://github.com/robjhyndman/">robjhyndman</a> on GitHub</li>
	
	<li><i class="fa-li ai ai-google-scholar" style="color:#03396c;font-size:80%;padding-top:6px;"></i><a href="https://scholar.google.com/citations?user=vamErfkAAAAJ">Google Scholar</a></li>
	
      </ul>
    </div>
    <div class="column small-12 medium-4">
      <h4>Subscribe</h4>
      <p><i><i class="fa fa-rss-square" style="color:#03396c;"></i> To receive updates from this site, you can subscribe to using an <a href="http://feeds.feedburner.com/ProfessorRobJHyndman">RSS feed reader</a> or <a href="https://feedburner.google.com/fb/a/mailverify?uri=ProfessorRobJHyndman">by email</a>.</i></p>
      <h4>Search</h4>
      <a id="searchsite">
	<form method="get" action="https://duckduckgo.com/">
	  <label for="search-field" class="show-for-sr">Search the site</label>
	  <input type="search" name="q" maxlength="255" placeholder="Search the site" id="search-field">
	  <input type="hidden" name="sites" value="https://robjhyndman.com"/>
	  <input type="hidden" name="k7" value="#faf8f8"/>
	  <input type="hidden" name="kj" value="#b33"/>
	  <input type="hidden" name="ky" value="#fafafa"/>
	  <input type="hidden" name="kx" value="b"/>
	  <input type="hidden" name="ko" value="-1"/>
	  <input type="hidden" name="k1" value="-1"/>
	  <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
	</form>
      </a>
    </div>
  </div>
  </span>
</footer>

    <div class="endofpage">
    <footer id="footer">
    <section class="wrapper small">Powered by <a href="http://gohugo.io">Hugo</a>
    and <a href="https://github.com/rstudio/blogdown">Blogdown</a>.
     &copy; <a href="https://robjhyndman.com">Rob&nbsp;J&nbsp;Hyndman</a> 1993&ndash;2018.
    </section>
    </footer>
    </div>

    <script src="https://robjhyndman.com/js/jquery.js"></script>
    <script src="https://robjhyndman.com/js/what-input.js"></script>
    <script src="https://robjhyndman.com/js/foundation.min.js"></script>
    <script src="https://robjhyndman.com/js/finite.js"></script>

    
    <script src="https://robjhyndman.com/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-5004894-1', 'auto');
ga('send', 'pageview');
</script>

 </body>
</html>
